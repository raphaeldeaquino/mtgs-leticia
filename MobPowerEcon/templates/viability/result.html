{% extends 'base.html' %}
{% set active_page = "viability" %}

{% block content %}
<section id="hero" class="services">
    <div class="container">
        <div class="form_wrapper">
            <div class="form_container">
                <div class="title_container">
                    <h2>Resultado da análise de viabilidade</h2>
                </div>
                <p style="padding-top:20px"><b>Opção selecionada:</b> {{ result['opcao'] }}</p>
                <p><b>Demanda dos eletropostos:</b></p>
                <ul>
                    {% for indice in range(result['Demanda dos eletropostos']|length) %}
                        <li>Ano {{ indice + 1 }}: {{ result['Demanda dos eletropostos'][indice] }} kWh</li>
                    {% endfor %}
                </ul>
                <div class="row clearfix">
                    <div class="col_half">
                        <p><b>Geração fotovoltaica:</b></p>
                        <ul>
                            {% for indice in range(result['Geração fotovoltaica']|length) %}
                                <li>Ano {{ indice + 1 }}: {{ result['Geração fotovoltaica'][indice] }} kWh</li>
                            {% endfor %}
                        </ul>
                    </div>
                    <div class="col_half">
                        <canvas id="grafico1"></canvas>
                    </div>
                </div>
                <p><b>Valor residual do sistema fotovoltaico:</b> R$ {{ result['Valor residual FV'] }}</p>
                <div class="row clearfix">
                    <div class="col_half">
                        <p><b>Faturas da concessionária:</b></p>
                        <ul>
                            {% for indice in range(result['Faturas concessionária']|length) %}
                                <li>Ano {{ indice + 1 }}: R$ {{ result['Faturas concessionária'][indice] }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                    <div class="col_half">
                        <p><b>Abatimento de energia:</b></p>
                        <ul>
                            {% for indice in range(result['Abatimento de energia']|length) %}
                                <li>Ano {{ indice + 1 }}: {{ result['Abatimento de energia'][indice] }} kWh</li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
                <p><b>Créditos restantes:</b></p>
                <ul>
                    {% for indice in range(result['Créditos restantes']|length) %}
                        <li>Ano {{ indice + 1 }}: {{ result['Créditos restantes'][indice] }} kWh</li>
                    {% endfor %}
                </ul>
                <p><b>Créditos restantes:</b></p>
                <ul>
                    {% for indice in range(result['Créditos restantes']|length) %}
                        <li>Ano {{ indice + 1 }}: {{ result['Créditos restantes'][indice] }} kWh</li>
                    {% endfor %}
                </ul>
                <div class="row clearfix">
                    <div class="col_half">
                        <p><b>Prestações de financiamento:</b></p>
                        <ul>
                            {% for indice in range(result['Vetor prestações de financiamento']|length) %}
                                <li>Mês {{ indice + 1 }}: R$ {{ result['Vetor prestações de financiamento'][indice] }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                    <div class="col_half">
                        <canvas id="grafico2"></canvas>
                    </div>
                </div>
                {% if 'Alíquota efetiva' in result %}
                    <div class="row clearfix">
                        <div class="col_half">
                            <p><b>Alíquota efetiva:</b></p>
                            {% for indice in range(result['Alíquota efetiva']|length) %}
                                <li>Ano {{ indice + 1 }}: {{ result['Alíquota efetiva'][indice] }}</li>
                            {% endfor %}
                        </div>
                        <div class="col_half">
                            <p><b>Desconto Simples Mensal:</b></p>
                            {% for indice in range(result['Desconto Simples Mensal']|length) %}
                                <li>Ano {{ indice + 1 }}: {{ result['Desconto Simples Mensal'][indice] }}</li>
                            {% endfor %}
                        </div>
                    </div>
                {% endif %}
                <p><b>Resultado final do fluxo de caixa:</b></p>
                <table id="data" class="table table-striped">
                    <thead>
                        <tr>
                            <th>Anos</th>
                            <th>Receita Bruta (+)</th>
                            <th>Imposto Simples Nacional (-)</th>
                            <th>Fatura de energia (-)</th>
                            <th>O&M (-)</th>
                            <th>Aluguel (-)</th>
                            <th>Financiamento (-)</th>
                            <th>Fluxo de Caixa (=)</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for indice in range(result['anos']|length) %}
                            <tr>
                                <td>{{ result['anos'][indice] }}</td>
                                <td><font color="blue">R$ {{ result['Receita Bruta'][indice] }}</font></td>
                                <td><font color="red">R$ {{ result['Imposto Simples Nacional'][indice] }}</font></td>
                                <td><font color="red">R$ {{ result['Fatura de energia'][indice] }}</font></td>
                                <td><font color="red">R$ {{ result['O&M'][indice] }}</font></td>
                                <td><font color="red">R$ {{ result['Aluguel'][indice] }}</font></td>
                                <td><font color="red">R$ {{ result['Financiamento'][indice] }}</font></td>
                                {% if result['Fluxo de Caixa'][indice][0] == '-' %}
                                    <td><font color="red">R$ {{ result['Fluxo de Caixa'][indice] }}</font></td>
                                {% else %}
                                    <td><font color="blue">R$ {{ result['Fluxo de Caixa'][indice] }}</font></td>
                                {% endif %}
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
                <p><b>Investimento inicial:</b> R$ {{ result['Investimento inicial'] }}</p>
                <p><b>Valor financiado:</b> R$ {{ result['Valor financiado'] }}</p>
                <p style="padding-top:30px"><b>Indicadores Econômicos</b></p>
                <p><b>VPL:</b> R$ {{ result['VPL'] }}</p>
                <p><b>TIR:</b> {{ result['TIR'] }} %</p>
                {% if 'Payback Descontado' in result %}
                    <p><b>Payback Descontado:</b> {{ result['Payback Descontado'] }} anos</p>
                {% else %}
                    <p>O payback descontado não foi atingido.</p>
                {% endif %}

            </div>
        </div>
    </div>
</section>
<script>
// Aqui você usaria Jinja2 para passar os dados para o JavaScript
var dados = {{ result|tojson }};

console.log(dados);

// Configuração do gráfico 1
var config1 = {
    type: 'bar',
    data: {
        labels: dados.anos,
        datasets: [{
            data: dados.geracoes,
            backgroundColor: 'rgba(20, 180, 50, 0.8)',
            borderColor: 'rgba(47, 158, 65, 1)',
            borderWidth: 1
        }]
    },
    options: {
        legend: {
            display: false
        },
        plugins: {
            datalabels: {
                display: true,
                color: '#ffffff',
                formatter: function(value, context) {
                    return value.toFixed(2);
                }
            }
        },
        tooltips: {
            callbacks: {
                label: function(tooltipItem, data) {
                    var value = data.datasets[tooltipItem.datasetIndex].data[tooltipItem.index];
                    return value.toFixed(2);
                }
            }
        },
        title: {
            display: true,
            text: 'Geração Fotovoltaica ao Longo dos Anos'
        },
        scales: {
            yAxes: [{
                scaleLabel: {
                    display: true,
                    labelString: 'Geração (kWh)'
                }
            }],
            xAxes: [{
                scaleLabel: {
                    display: true,
                    labelString: 'Ano'
                }
            }]
        }
    }
};

// Configuração do gráfico 2
var config2 = {
    type: 'line',
    data: {
        labels: dados.meses,
        datasets: [{
            data: dados.juros_mensais,
            label: "Juros mensais",
            borderColor: "#3e95cd",
            fill: false
        }, {
            data: dados.amortizacao_mensal,
            label: "Amortização mensal",
            borderColor: "#8e5ea2",
            fill: false
        }, {
            data: dados.prestacoes,
            label: "Prestações",
            borderColor: "#3cba9f",
            fill: false
        }]
    },
    options: {
        title: {
            display: true,
            text: 'Financiamento'
        },
        hover: {
            mode: 'index',
            intersect: true
        },
        scales: {
            yAxes: [{
                scaleLabel: {
                    display: true,
                    labelString: 'Valor (R$)'
                }
            }],
            xAxes: [{
                scaleLabel: {
                    display: true,
                    labelString: 'Mês'
                }
            }]
        }
    }
};

// Renderizando o gráfico
var ctx1 = document.getElementById("grafico1");
console.log(ctx1);
var myChart1 = new Chart(ctx1, config1);
console.log(myChart1);
var ctx2 = document.getElementById("grafico2");
console.log(ctx2);
var myChart2 = new Chart(ctx2, config2);
console.log(myChart2);


</script>
{% endblock %}