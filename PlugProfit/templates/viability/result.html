{% extends 'base.html' %}
{% set active_page = "viability" %}

{% block content %}
<section id="hero" class="services">
    <div class="container">
        <div class="form_wrapper">
            <div class="form_container">
                <div class="title_container">
                    <h2>Resultado da análise de viabilidade</h2>
                </div>
                <p style="padding-top:20px"><b>Opção selecionada:</b> {{ result['opcao'] }}</p>
                {% if result['opcao'] == 'Análise de sensibilidade do valor da recarga' %}
                    <p><b>Recarga por dia:</b> {{ result['Recarga por dia'] }} horas</p>
                {% endif %}
                {% if result['opcao'] == 'Sem análise de sensibilidade'
                or result['opcao'] == 'Análise de sensibilidade do valor da recarga'
                or result['opcao'] == 'Análise de sensibilidade da potência do sistema fotovoltaico' %}
                    <p><b>Demanda dos eletropostos:</b></p>
                    <ul>
                        {% for indice in range(result['Demanda dos eletropostos']|length) %}
                            <li>Ano {{ indice + 1 }}: {{ result['Demanda dos eletropostos'][indice] }} kWh</li>
                        {% endfor %}
                    </ul>
                {% endif %}
                {% if result['opcao'] != 'Análise de sensibilidade da potência do sistema fotovoltaico' %}
                <div class="row clearfix">
                    <div class="col_half">
                        <p><b>Geração fotovoltaica:</b></p>
                        <ul>
                            {% for indice in range(result['Geração fotovoltaica']|length) %}
                                <li>Ano {{ indice + 1 }}: {{ result['Geração fotovoltaica'][indice] }} kWh</li>
                            {% endfor %}
                        </ul>
                    </div>
                    <div class="col_half">
                        <canvas id="grafico1"></canvas>
                    </div>
                </div>
                <p><b>Valor residual do sistema fotovoltaico:</b> R$ {{ result['Valor residual FV'] }}</p>
                {% endif %}
                {% if result['opcao'] == 'Sem análise de sensibilidade' or result['opcao'] == 'Análise de sensibilidade do valor da recarga' %}
                    <div class="row clearfix">
                        <div class="col_half">
                            <p><b>Faturas da concessionária:</b></p>
                            <ul>
                                {% for indice in range(result['Faturas concessionária']|length) %}
                                    <li>Ano {{ indice + 1 }}: R$ {{ result['Faturas concessionária'][indice] }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                        <div class="col_half">
                            <p><b>Abatimento de energia:</b></p>
                            <ul>
                                {% for indice in range(result['Abatimento de energia']|length) %}
                                    <li>Ano {{ indice + 1 }}: {{ result['Abatimento de energia'][indice] }} kWh</li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                    <p><b>Créditos restantes:</b></p>
                    <ul>
                        {% for indice in range(result['Créditos restantes']|length) %}
                            <li>Ano {{ indice + 1 }}: {{ result['Créditos restantes'][indice] }} kWh</li>
                        {% endfor %}
                    </ul>
                {% endif %}
                {% if result['opcao'] != 'Análise de sensibilidade da potência do sistema fotovoltaico' %}
                <div class="row clearfix">
                    <div class="col_half">
                        <p><b>Prestações de financiamento:</b></p>
                        <ul>
                            {% for indice in range(result['Vetor prestações de financiamento']|length) %}
                                <li>Mês {{ indice + 1 }}: R$ {{ result['Vetor prestações de financiamento'][indice] }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                    <div class="col_half">
                        <canvas id="grafico2"></canvas>
                    </div>
                </div>
                {% if 'Alíquota efetiva' in result %}
                    <div class="row clearfix">
                        <div class="col_half">
                            <p><b>Alíquota efetiva:</b></p>
                            {% for indice in range(result['Alíquota efetiva']|length) %}
                                <li>Ano {{ indice + 1 }}: {{ result['Alíquota efetiva'][indice] }}</li>
                            {% endfor %}
                        </div>
                        <div class="col_half">
                            <p><b>Desconto Simples Mensal:</b></p>
                            {% for indice in range(result['Desconto Simples Mensal']|length) %}
                                <li>Ano {{ indice + 1 }}: {{ result['Desconto Simples Mensal'][indice] }}</li>
                            {% endfor %}
                        </div>
                    </div>
                {% endif %}
                {% endif %}
                {% if result['opcao'] == 'Sem análise de sensibilidade' %}
                    <p><b>Resultado final do fluxo de caixa:</b></p>
                    <table id="data" class="table table-striped">
                        <thead>
                            <tr>
                                <th>Anos</th>
                                <th>Receita Bruta (+)</th>
                                <th>Imposto Simples Nacional (-)</th>
                                <th>Fatura de energia (-)</th>
                                <th>O&M (-)</th>
                                <th>Aluguel (-)</th>
                                <th>Financiamento (-)</th>
                                <th>Fluxo de Caixa (=)</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for indice in range(result['anos']|length) %}
                                <tr>
                                    <td>{{ result['anos'][indice] }}</td>
                                    <td><font color="blue">R$ {{ result['Receita Bruta'][indice] }}</font></td>
                                    <td><font color="red">R$ {{ result['Imposto Simples Nacional'][indice] }}</font></td>
                                    <td><font color="red">R$ {{ result['Fatura de energia'][indice] }}</font></td>
                                    <td><font color="red">R$ {{ result['O&M'][indice] }}</font></td>
                                    <td><font color="red">R$ {{ result['Aluguel'][indice] }}</font></td>
                                    <td><font color="red">R$ {{ result['Financiamento'][indice] }}</font></td>
                                    {% if result['Fluxo de Caixa'][indice][0] == '-' %}
                                        <td><font color="red">R$ {{ result['Fluxo de Caixa'][indice] }}</font></td>
                                    {% else %}
                                        <td><font color="blue">R$ {{ result['Fluxo de Caixa'][indice] }}</font></td>
                                    {% endif %}
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    <p><b>Investimento inicial:</b> R$ {{ result['Investimento inicial'] }}</p>
                    <p><b>Valor financiado:</b> R$ {{ result['Valor financiado'] }}</p>
                    <p style="padding-top:30px"><b>Indicadores Econômicos</b></p>
                    <p><b>VPL:</b> R$ {{ result['VPL'] }}</p>
                    <p><b>TIR:</b> {{ result['TIR'] }} %</p>
                    {% if 'Payback Descontado' in result %}
                        <p><b>Payback Descontado:</b> {{ result['Payback Descontado'] }} anos</p>
                    {% else %}
                        <p>O payback descontado não foi atingido.</p>
                    {% endif %}
                {% endif %}
                {% if result['opcao'] == 'Análise de sensibilidade do valor da recarga' or result['opcao'] == 'Análise de sensibilidade da recarga por dia' %}
                    <canvas id="grafico3"></canvas>
                {% endif %}
                {% if result['opcao'] == 'Análise de sensibilidade da potência do sistema fotovoltaico' %}
                <p><b>Valor ótimo do VPL:</b> R$ {{ result['Valor ótimo do VPL em R$'] }}</p>
                <p><b>Potência ótima do sistema fotovoltaico:</b> {{ result['Potência ótima do sistema fotovoltaico em kW'] }} kW</p>
                <canvas id="grafico4"></canvas>
                {% endif %}
            </div>
        </div>
    </div>
</section>
<script>
// Aqui você usaria Jinja2 para passar os dados para o JavaScript
var dados = {{ result|tojson }};

console.log(dados);

if (dados['opcao'] != 'Análise de sensibilidade da potência do sistema fotovoltaico') {
    // Configuração do gráfico 1
    var config1 = {
        type: 'bar',
        data: {
            labels: dados.anos,
            datasets: [{
                data: dados.geracoes,
                backgroundColor: 'rgba(20, 180, 50, 0.8)',
                borderColor: 'rgba(47, 158, 65, 1)',
                borderWidth: 1,
                label: "Geração",
            }]
        },
        options: {
            plugins: {
                title: {
                    display: true,
                    text: 'Geração Fotovoltaica ao Longo dos Anos',
                    font: {
                        size: 16
                    }
                },
            },
            legend: {
                display: false
            },
            tooltips: {
                callbacks: {
                    label: function(tooltipItem, data) {
                        var value = data.datasets[tooltipItem.datasetIndex].data[tooltipItem.index];
                        return value.toFixed(2);
                    }
                }
            },
            scales: {
                y: {
                    title: {
                        display: true,
                        text: 'Geração (kWh)'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Ano'
                    }
                }
            }
        }
    };

    // Configuração do gráfico 2
    var config2 = {
        type: 'line',
        data: {
            labels: dados.meses,
            datasets: [{
                data: dados.juros_mensais,
                label: "Juros mensais",
                borderColor: "#3e95cd",
                fill: false
            }, {
                data: dados.amortizacao_mensal,
                label: "Amortização mensal",
                borderColor: "#8e5ea2",
                fill: false
            }, {
                data: dados.prestacoes,
                label: "Prestações",
                borderColor: "#3cba9f",
                fill: false
            }]
        },
        options: {
            plugins: {
                title: {
                    display: true,
                    text: 'Financiamento',
                    font: {
                        size: 16
                    }
                },
            },
            hover: {
                mode: 'index',
                intersect: true
            },
            scales: {
                y: {
                    title: {
                        display: true,
                        text: 'Valor (R$)'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Mês'
                    }
                }
            }
        }
    };

    // Renderizando o gráfico
    var ctx1 = document.getElementById("grafico1");
    var myChart1 = new Chart(ctx1, config1);
    var ctx2 = document.getElementById("grafico2");
    var myChart2 = new Chart(ctx2, config2);
}

if (dados['opcao'] == 'Análise de sensibilidade do valor da recarga' || dados['opcao'] == 'Análise de sensibilidade da recarga por dia') {
    var config3 = {
        type: 'line',
        data: {
            labels: dados.valor_recarga_range,
            datasets: [{
                data: dados.vpl_positivo,
                label: "Viabilidade (VPL >= 0)",
                borderColor: "#5fa2e0",
                fill: false
            }, {
                data: dados.vpl_negativo,
                label: "Inviabilidade (VPL < 0)",
                borderColor: "#cd3e3e",
                fill: false
            }]
        },
        options: {
            plugins: {
                title: {
                    display: true,
                    text: 'Análise de Sensibilidade do VPL',
                    font: {
                        size: 16
                    }
                },
            },
            hover: {
                mode: 'index',
                intersect: true
            },
            scales: {
                y: {
                    title: {
                        display: true,
                        text: 'VPL (R$)'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Valor de Recarga (R$)'
                    },
                }
            }
        }
    };

    var ctx3 = document.getElementById("grafico3");
    var myChart3 = new Chart(ctx3, config3);
}

if (dados['opcao'] == 'Análise de sensibilidade da potência do sistema fotovoltaico') {
    var config4 = {
        type: 'line',
        data: {
            labels: dados.pot_fv_range,
            datasets: [{
                data: dados.vpl_positivo,
                label: "Viabilidade (VPL >= 0)",
                borderColor: "#5fa2e0",
                fill: false
            }, {
                data: dados.vpl_negativo,
                label: "Inviabilidade (VPL < 0)",
                borderColor: "#cd3e3e",
                fill: false
            }]
        },
        options: {
            plugins: {
                title: {
                    display: true,
                    text: 'Análise de Sensibilidade do VPL',
                    font: {
                        size: 16
                    }
                },
            },
            hover: {
                mode: 'index',
                intersect: true
            },
            scales: {
                y: {
                    title: {
                        display: true,
                        text: 'VPL (R$)'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Potência do sistema fotovoltaico (kW)'
                    },
                }
            }
        }
    };

    var ctx4 = document.getElementById("grafico4");
    var myChart4 = new Chart(ctx4, config4);
}

</script>
{% endblock %}